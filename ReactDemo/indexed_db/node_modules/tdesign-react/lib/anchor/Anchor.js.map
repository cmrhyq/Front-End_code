{"version":3,"file":"Anchor.js","sources":["../../src/anchor/Anchor.tsx"],"sourcesContent":["import React, { useState, useRef, useEffect, useCallback, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport isEmpty from 'lodash/isEmpty';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps } from '../common';\nimport { TdAnchorProps } from './type';\nimport useConfig from '../hooks/useConfig';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport { canUseDocument, getScrollContainer } from '../_util/dom';\nimport Affix from '../affix';\nimport { AnchorContext, Item } from './AnchorContext';\nimport { getOffsetTop, getScroll, scrollTo, AnchorContainer } from './_util/dom';\nimport AnchorItem from './AnchorItem';\nimport AnchorTarget from './AnchorTarget';\nimport { anchorDefaultProps } from './defaultProps';\n\nexport interface AnchorProps extends TdAnchorProps, StyledProps {\n  children?: React.ReactNode;\n}\n\ninterface IntervalRef {\n  // 收集 anchor-item\n  items: string[];\n  // 容器\n  scrollContainer: AnchorContainer;\n  // 收集各项 item 的信息与节点\n  handleScrollLock: boolean;\n}\n\nconst ANCHOR_SHARP_REGEXP = /#(\\S+)$/;\n\nconst Anchor = forwardRefWithStatics(\n  (props: AnchorProps, ref: React.Ref<HTMLDivElement>) => {\n    const {\n      affixProps,\n      bounds,\n      targetOffset,\n      container,\n      size,\n      children,\n      cursor,\n      onClick,\n      onChange,\n      className,\n      ...rest\n    } = props;\n\n    const { classPrefix } = useConfig();\n\n    const [activeItem, setActiveItem] = useState<string>('');\n    const [cursorStyle, setCursorStyle] = useState<{ top: string; height?: string; opacity: number }>({\n      top: '0px',\n      height: '0px',\n      opacity: 0,\n    });\n\n    const anchorEl = useRef(null);\n    const intervalRef = useRef<IntervalRef>({\n      items: [],\n      scrollContainer: canUseDocument ? window : null,\n      handleScrollLock: false,\n    });\n\n    useImperativeHandle(ref, () => anchorEl.current);\n\n    /**\n     * 注册锚点\n     * @param href 链接\n     */\n    const registerItem = (href: string): void => {\n      const { items } = intervalRef.current;\n      if (ANCHOR_SHARP_REGEXP.test(href) && items.indexOf(href) < 0) items.push(href);\n    };\n\n    const unregisterItem = (href: string): void => {\n      const { items } = intervalRef.current;\n      intervalRef.current.items = items.filter((item) => href !== item);\n    };\n\n    const getAnchorTarget = (href: string): HTMLElement => document.querySelector(href);\n\n    const handleScrollTo = (link: string) => {\n      const anchor = getAnchorTarget(link);\n      if (!anchor) return;\n      onChange?.(link, activeItem);\n      setActiveItem(link);\n      intervalRef.current.handleScrollLock = true;\n      const { scrollContainer } = intervalRef.current;\n      const scrollTop = getScroll(scrollContainer);\n      const offsetTop = getOffsetTop(anchor, scrollContainer);\n      const top = scrollTop + offsetTop - targetOffset;\n      scrollTo(top, {\n        container: scrollContainer,\n      }).then(() => {\n        intervalRef.current.handleScrollLock = false;\n      });\n    };\n\n    const handleClick = (item: Item, e: React.MouseEvent<HTMLDivElement>) => {\n      onClick?.({ e, ...item });\n      handleScrollTo(item.href);\n    };\n\n    useEffect(() => {\n      // update point style\n      const pointEl = anchorEl.current.querySelector?.(`.${classPrefix}-is-active>a`) as HTMLAnchorElement;\n      if (!pointEl) {\n        setCursorStyle(null);\n      } else {\n        const { offsetTop: top, offsetHeight: height } = pointEl;\n        setCursorStyle({ top: `${top}px`, height: `${height}px`, opacity: 1 });\n      }\n    }, [activeItem, classPrefix]);\n\n    const handleScroll = useCallback(() => {\n      const { scrollContainer, handleScrollLock } = intervalRef.current;\n      if (handleScrollLock) return;\n      const { items } = intervalRef.current;\n      const filters: { top: number; href: string }[] = [];\n      let active = '';\n      // 找出所有当前 top 小于预设值\n      items.forEach((href) => {\n        const anchor = getAnchorTarget(href);\n        if (!anchor) return;\n        const top = getOffsetTop(anchor, scrollContainer);\n        if (top <= bounds + targetOffset) {\n          filters.push({\n            href,\n            top,\n          });\n        }\n      });\n\n      // 找出小于预设值集合中top最大的\n      if (filters.length) {\n        const latest = filters.reduce((prev, cur) => (prev.top > cur.top ? prev : cur));\n        active = latest.href;\n      }\n      if (active !== activeItem) {\n        onChange?.(active, activeItem);\n        setActiveItem(active);\n      }\n    }, [activeItem, bounds, onChange, targetOffset]);\n\n    useEffect(() => {\n      intervalRef.current.scrollContainer = getScrollContainer(container);\n      const { scrollContainer } = intervalRef.current;\n\n      handleScroll();\n      scrollContainer.addEventListener('scroll', handleScroll);\n      return () => {\n        scrollContainer.removeEventListener('scroll', handleScroll);\n      };\n    }, [container, handleScroll]);\n\n    const anchorClass = classNames(\n      `${classPrefix}-anchor`,\n      {\n        [`${classPrefix}-size-s`]: size === 'small',\n        [`${classPrefix}-size-m`]: size === 'medium',\n        [`${classPrefix}-size-l`]: size === 'large',\n      },\n      className,\n    );\n\n    const CursorCmp = () => {\n      if (isFunction(cursor)) return cursor();\n      if (isEmpty(cursor)) return <div className={`${classPrefix}-anchor__line-cursor`}></div>;\n      return cursor;\n    };\n\n    const Cmp = (\n      <AnchorContext.Provider\n        value={{\n          onClick: handleClick,\n          activeItem,\n          registerItem,\n          unregisterItem,\n        }}\n      >\n        <div {...rest} className={anchorClass} ref={anchorEl}>\n          <div className={`${classPrefix}-anchor__line`}>\n            <div className={`${classPrefix}-anchor__line-cursor-wrapper`} style={cursorStyle}>\n              {CursorCmp()}\n            </div>\n          </div>\n          {children}\n        </div>\n      </AnchorContext.Provider>\n    );\n\n    return isEmpty(affixProps) ? Cmp : <Affix {...affixProps}>{Cmp}</Affix>;\n  },\n  {\n    AnchorItem,\n    AnchorTarget,\n  },\n);\n\nAnchor.displayName = 'Anchor';\nAnchor.defaultProps = anchorDefaultProps;\n\nexport default Anchor;\n"],"names":["ANCHOR_SHARP_REGEXP","Anchor","forwardRefWithStatics","props","ref","affixProps","bounds","targetOffset","container","size","children","cursor","onClick","onChange","className","rest","useConfig","classPrefix","useState","activeItem","setActiveItem","top","height","opacity","cursorStyle","setCursorStyle","anchorEl","useRef","intervalRef","items","scrollContainer","canUseDocument","window","handleScrollLock","useImperativeHandle","current","registerItem","href","test","indexOf","push","unregisterItem","filter","item","getAnchorTarget","document","querySelector","handleScrollTo","link","anchor","scrollTop","getScroll","offsetTop","getOffsetTop","scrollTo","then","handleClick","e","useEffect","pointEl","offsetHeight","handleScroll","useCallback","filters","active","forEach","length","latest","reduce","prev","cur","getScrollContainer","addEventListener","removeEventListener","anchorClass","classNames","CursorCmp","isFunction","isEmpty","React","createElement","Cmp","AnchorContext","Provider","value","style","Affix","AnchorItem","AnchorTarget","displayName","defaultProps","anchorDefaultProps"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6BA,IAAMA,mBAAsB,GAAA,SAA5B,CAAA;AAEMC,IAAAA,MAAS,GAAAC,qBAAA,CACb,UAACC,KAAD,EAAqBC,GAArB,EAAwD;AAAA,EAAA,IAAA,WAAA,CAAA;;AAChD,EAAA,IACJC,UADI,GAYFF,KAZE,CACJE,UADI;AAAA,MAEJC,MAFI,GAYFH,KAZE,CAEJG,MAFI;AAAA,MAGJC,YAHI,GAYFJ,KAZE,CAGJI,YAHI;AAAA,MAIJC,SAJI,GAYFL,KAZE,CAIJK,SAJI;AAAA,MAKJC,IALI,GAYFN,KAZE,CAKJM,IALI;AAAA,MAMJC,QANI,GAYFP,KAZE,CAMJO,QANI;AAAA,MAOJC,MAPI,GAYFR,KAZE,CAOJQ,MAPI;AAAA,MAQJC,OARI,GAYFT,KAZE,CAQJS,OARI;AAAA,MASJC,QATI,GAYFV,KAZE,CASJU,QATI;AAAA,MAUJC,SAVI,GAYFX,KAZE,CAUJW,SAVI;MAWDC,IAXC,4BAYFZ,KAZE,EAAA,SAAA,CAAA,CAAA;;AAcA,EAAA,IAAA,UAAA,GAAkBa,SAAU,EAA5B;MAAEC,WAAF,cAAEA,WAAF,CAAA;;EAEN,IAAoCC,SAAAA,GAAAA,SAAiB,GAArD;AAAA,MAAA,UAAA,GAAA,cAAA,CAAA,SAAA,EAAA,CAAA,CAAA;AAAA,MAAOC,UAAP,GAAA,UAAA,CAAA,CAAA,CAAA;AAAA,MAAmBC,aAAnB,GAAA,UAAA,CAAA,CAAA,CAAA,CAAA;;AACA,EAAA,IAAA,UAAA,GAAsCF,QAA4D,CAAA;AAChGG,IAAAA,GAAK,EAAA,KAD2F;AAEhGC,IAAAA,MAAQ,EAAA,KAFwF;AAGhGC,IAAAA,OAAS,EAAA,CAAA;AAHuF,GAAA,CAAlG;AAAA,MAAA,UAAA,GAAA,cAAA,CAAA,UAAA,EAAA,CAAA,CAAA;AAAA,MAAOC,WAAP,GAAA,UAAA,CAAA,CAAA,CAAA;AAAA,MAAoBC,cAApB,GAAA,UAAA,CAAA,CAAA,CAAA,CAAA;;AAMM,EAAA,IAAAC,QAAA,GAAWC,OAAO,KAAlB,CAAA;EACN,IAAMC,cAAcD,MAAoB,CAAA;AACtCE,IAAAA,OAAO,EAD+B;AAEtCC,IAAAA,eAAA,EAAiBC,iBAAiBC,SAAS,IAFL;AAGtCC,IAAAA,gBAAkB,EAAA,KAAA;AAHoB,GAAA,CAAxC,CAAA;EAMoBC,mBAAA,CAAA9B,GAAA,EAAK,YAAA;IAAA,OAAMsB,QAAA,CAASS,OAAf,CAAA;AAAA,GAAL,CAAA,CAAA;;AAMd,EAAA,IAAAC,YAAA,GAAe,SAAfA,YAAe,CAACC,IAAD,EAAwB;AACrC,IAAA,IAAER,KAAF,GAAYD,WAAY,CAAAO,OAAxB,CAAEN,KAAF,CAAA;AACN,IAAA,IAAI7B,oBAAoBsC,IAApB,CAAyBD,IAAzB,CAAA,IAAkCR,KAAM,CAAAU,OAAN,CAAcF,IAAd,IAAsB,CAA5D,EAA+DR,KAAA,CAAMW,IAAN,CAAWH,IAAX,CAAA,CAAA;GAF3D,CAAA;;AAKA,EAAA,IAAAI,cAAA,GAAiB,SAAjBA,cAAiB,CAACJ,IAAD,EAAwB;AACvC,IAAA,IAAER,KAAF,GAAYD,WAAY,CAAAO,OAAxB,CAAEN,KAAF,CAAA;IACND,WAAA,CAAYO,OAAZ,CAAoBN,KAApB,GAA4BA,KAAA,CAAMa,MAAN,CAAa,UAACC,IAAD,EAAA;MAAA,OAAUN,SAASM,IAAnB,CAAA;AAAA,KAAb,CAA5B,CAAA;GAFI,CAAA;;AAKN,EAAA,IAAMC,eAAkB,GAAA,SAAlBA,eAAkB,CAACP,IAAD,EAAA;AAAA,IAAA,OAA+BQ,QAAA,CAASC,aAAT,CAAuBT,IAAvB,CAA/B,CAAA;GAAxB,CAAA;;AAEM,EAAA,IAAAU,cAAA,GAAiB,SAAjBA,cAAiB,CAACC,IAAD,EAAkB;AACjC,IAAA,IAAAC,MAAA,GAASL,gBAAgBI,KAAzB,CAAA;IACN,IAAI,CAACC,MAAL,EAAa,OAAA;IACbpC,QAAA,KAAA,IAAA,IAAAA,QAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAAA,QAAA,CAAWmC,IAAX,EAAiB7B,UAAjB,CAAA,CAAA;IACAC,aAAA,CAAc4B,IAAd,CAAA,CAAA;AACApB,IAAAA,WAAA,CAAYO,OAAZ,CAAoBF,gBAApB,GAAuC,IAAvC,CAAA;AACM,IAAA,IAAEH,eAAF,GAAsBF,WAAY,CAAAO,OAAlC,CAAEL,eAAF,CAAA;AACA,IAAA,IAAAoB,SAAA,GAAYC,UAAUrB,gBAAtB,CAAA;AACA,IAAA,IAAAsB,SAAA,GAAYC,YAAa,CAAAJ,MAAA,EAAQnB,eAAR,CAAzB,CAAA;AACA,IAAA,IAAAT,GAAA,GAAM6B,YAAYE,SAAZ,GAAwB7C,YAA9B,CAAA;IACN+C,QAAA,CAASjC,GAAT,EAAc;AACZb,MAAAA,SAAW,EAAAsB,eAAAA;AADC,KAAd,CAAA,CAEGyB,IAFH,CAEQ,YAAM;AACZ3B,MAAAA,WAAA,CAAYO,OAAZ,CAAoBF,gBAApB,GAAuC,KAAvC,CAAA;KAHF,CAAA,CAAA;GAVI,CAAA;;EAiBA,IAAAuB,WAAA,GAAc,SAAdA,WAAc,CAACb,IAAD,EAAac,CAAb,EAAqD;AACvE7C,IAAAA,OAAA,KAAA,IAAA,IAAAA,OAAA,KAAA,KAAA,CAAA,YAAAA,OAAA,CAAA,aAAA,CAAA;AAAY6C,MAAAA,CAAA,EAAAA,CAAAA;AAAZ,KAAA,EAAkBd,IAAlB,CAAA,CAAA,CAAA;AACAI,IAAAA,cAAA,CAAeJ,KAAKN,IAApB,CAAA,CAAA;GAFI,CAAA;;AAKNqB,EAAAA,SAAA,CAAU,YAAM;AAAA,IAAA,IAAA,qBAAA,EAAA,iBAAA,CAAA;;IAEd,IAAMC,OAAU,GAAA,CAAA,qBAAA,GAAA,CAAA,iBAAA,GAAAjC,QAAA,CAASS,OAAT,EAAiBW,aAAjB,MAAA,IAAA,IAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,qBAAqC7B,CAAAA,IAAAA,CAAAA,iBAAAA,EAAAA,GAAAA,CAAAA,MAAAA,CAAAA,WAArC,EAAhB,cAAA,CAAA,CAAA,CAAA;;IACA,IAAI,CAAC0C,OAAL,EAAc;MACZlC,cAAA,CAAe,IAAf,CAAA,CAAA;AACK,KAFP,MAEO;AACL,MAAA,IAAmBJ,GAAnB,GAAiDsC,OAAjD,CAAQP,SAAR;AAAA,UAAsC9B,MAAtC,GAAiDqC,OAAjD,CAAwBC,YAAxB,CAAA;AACenC,MAAAA,cAAA,CAAA;QAAEJ,eAAQA,KAAV,IAAA,CAAA;QAAmBC,kBAAWA,QAA9B,IAAA,CAAA;AAA0CC,QAAAA,OAAS,EAAA,CAAA;AAAnD,OAAA,CAAA,CAAA;AACjB,KAAA;AACC,GATH,EASG,CAACJ,UAAD,EAAaF,WAAb,CATH,CAAA,CAAA;AAWM,EAAA,IAAA4C,YAAA,GAAeC,YAAY,YAAM;IACrC,IAA8ClC,oBAAAA,GAAAA,WAAY,CAAAO,OAA1D;QAAQL,eAAR,wBAAQA,eAAR;QAAyBG,gBAAzB,wBAAyBA,gBAAzB,CAAA;AACI,IAAA,IAAAA,gBAAA,EAAkB,OAAA;AAChB,IAAA,IAAEJ,KAAF,GAAYD,WAAY,CAAAO,OAAxB,CAAEN,KAAF,CAAA;IACN,IAAMkC,UAA2C,EAAjD,CAAA;IACA,IAAIC,MAAS,GAAA,EAAb,CAAA;AAEMnC,IAAAA,KAAA,CAAAoC,OAAA,CAAQ,UAAC5B,IAAD,EAAU;AAChB,MAAA,IAAAY,MAAA,GAASL,gBAAgBP,KAAzB,CAAA;MACN,IAAI,CAACY,MAAL,EAAa,OAAA;AACP,MAAA,IAAA5B,GAAA,GAAMgC,YAAa,CAAAJ,MAAA,EAAQnB,eAAR,CAAnB,CAAA;;AACF,MAAA,IAAAT,GAAA,IAAOf,SAASC,YAAhB,EAA8B;QAChCwD,OAAA,CAAQvB,IAAR,CAAa;AACXH,UAAAA,IAAA,EAAAA,IADW;AAEXhB,UAAAA,GAAA,EAAAA,GAAAA;SAFF,CAAA,CAAA;AAIF,OAAA;KATI,CAAA,CAAA;;IAaN,IAAI0C,QAAQG,MAAZ,EAAoB;MACZ,IAAAC,MAAA,GAASJ,OAAQ,CAAAK,MAAR,CAAe,UAACC,IAAD,EAAOC,GAAP,EAAA;QAAA,OAAgBD,IAAA,CAAKhD,GAAL,GAAWiD,GAAA,CAAIjD,GAAf,GAAqBgD,IAArB,GAA4BC,GAA5C,CAAA;AAAA,OAAf,CAAT,CAAA;MACNN,MAAA,GAASG,MAAO,CAAA9B,IAAhB,CAAA;AACF,KAAA;;IACA,IAAI2B,WAAW7C,UAAf,EAA2B;MACzBN,QAAA,KAAA,IAAA,IAAAA,QAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAAA,QAAA,CAAWmD,MAAX,EAAmB7C,UAAnB,CAAA,CAAA;MACAC,aAAA,CAAc4C,MAAd,CAAA,CAAA;AACF,KAAA;KACC,CAAC7C,UAAD,EAAab,MAAb,EAAqBO,QAArB,EAA+BN,YAA/B,EA5BG,CAAA;AA8BNmD,EAAAA,SAAA,CAAU,YAAM;IACF9B,WAAA,CAAAO,OAAA,CAAQL,eAAR,GAA0ByC,kBAAA,CAAmB/D,SAAnB,CAA1B,CAAA;AACN,IAAA,IAAEsB,eAAF,GAAsBF,WAAY,CAAAO,OAAlC,CAAEL,eAAF,CAAA;IAEO+B,YAAA,EAAA,CAAA;AACG/B,IAAAA,eAAA,CAAA0C,gBAAA,CAAiB,QAAjB,EAA2BX,YAA3B,CAAA,CAAA;AAChB,IAAA,OAAO,YAAM;AACK/B,MAAAA,eAAA,CAAA2C,mBAAA,CAAoB,QAApB,EAA8BZ,YAA9B,CAAA,CAAA;KADlB,CAAA;AAGC,GATH,EASG,CAACrD,SAAD,EAAYqD,YAAZ,CATH,CAAA,CAAA;EAWA,IAAMa,WAAc,GAAAC,UAAA,CACf1D,EAAAA,CAAAA,MAAAA,CAAAA,WADe,wEAGZA,WAHY,EAAA,SAAA,CAAA,EAGWR,IAAS,KAAA,OAHpB,CAAA,EAAA,eAAA,CAAA,WAAA,EAAA,EAAA,CAAA,MAAA,CAIZQ,WAJY,EAIWR,SAAAA,CAAAA,EAAAA,IAAS,KAAA,QAJpB,CAKZQ,EAAAA,eAAAA,CAAAA,WAAAA,EAAAA,EAAAA,CAAAA,MAAAA,CAAAA,WALY,EAKWR,SAAAA,CAAAA,EAAAA,IAAS,KAAA,OALpB,CAOlBK,EAAAA,WAAAA,GAAAA,SAPkB,CAApB,CAAA;;AAUA,EAAA,IAAM8D,YAAY,SAAZA,SAAY,GAAM;AACtB,IAAA,IAAIC,aAAWlE,OAAf,EAAwB,OAAOA,MAAO,EAAd,CAAA;AACxB,IAAA,IAAImE,UAAQnE,OAAZ,EAAqB,sBAAQoE,KAAA,CAAAC,aAAA,CAAA,KAAA,EAAA;AAAIlE,MAAAA,qBAAcG;AAAlB,KAAA,CAAR,CAAA;AACd,IAAA,OAAAN,MAAA,CAAA;GAHT,CAAA;;EAMM,IAAAsE,GAAA,kBACHF,KAAA,CAAAC,aAAA,CAAAE,aAAA,CAAcC,QAAd,EAAA;AACCC,IAAAA,KAAO,EAAA;AACLxE,MAAAA,OAAS,EAAA4C,WADJ;AAELrC,MAAAA,UAAA,EAAAA,UAFK;AAGLiB,MAAAA,YAAA,EAAAA,YAHK;AAILK,MAAAA,cAAA,EAAAA,cAAAA;AAJK,KAAA;GADR,iBAQEsC,KAAA,CAAAC,aAAA,CAAA,KAAA,kCAAQjE,IAAR,CAAA,EAAA,EAAA,EAAA;AAAcD,IAAAA,SAAW,EAAA4D,WAAzB;AAAsCtE,IAAAA,GAAK,EAAAsB,QAAAA;AAA3C,GAAA,CAAA,iBACEqD,KAAA,CAAAC,aAAA,CAAA,KAAA,EAAA;AAAIlE,IAAAA,qBAAcG;AAAlB,GAAA,iBACE8D,KAAA,CAAAC,aAAA,CAAA,KAAA,EAAA;IAAIlE,qBAAcG,aAAlB,8BAAA,CAAA;AAA6DoE,IAAAA,KAAO,EAAA7D,WAAAA;GAApE,EACEoD,SAAU,EADZ,CADF,CADF,EAMElE,QANF,CARF,CADG,CAAA;AAoBN,EAAA,OAAOoE,SAAQ,CAAAzE,UAAA,CAAR,GAAsB4E,GAAtB,kBAA6BF,KAAA,CAAAC,aAAA,CAAAM,KAAA,oBAAUjF,UAAV,CAAA,EAAuB4E,GAAvB,CAApC,CAAA;AACF,CAjKa,EAkKb;AACEM,EAAAA,UAAA,EAAAA,UADF;AAEEC,EAAAA,YAAA,EAAAA,YAAAA;AAFF,CAlKa,EAAf;AAwKAvF,MAAA,CAAOwF,WAAP,GAAqB,QAArB,CAAA;AACAxF,MAAA,CAAOyF,YAAP,GAAsBC,kBAAtB;;;;"}