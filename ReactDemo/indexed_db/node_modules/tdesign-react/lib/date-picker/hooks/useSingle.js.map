{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-react';\nimport dayjs from 'dayjs';\nimport classNames from 'classnames';\nimport useConfig from '../../hooks/useConfig';\nimport useGlobalIcon from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps } from '../type';\nimport { isValidDate, formatDate, formatTime, getDefaultFormat } from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\n\nexport default function useSingleInput(props: TdDatePickerProps) {\n  const { classPrefix, datePicker: globalDatePickerConfig } = useConfig();\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const name = `${classPrefix}-date-picker`;\n\n  const { format, valueType, timeFormat } = getDefaultFormat({\n    mode: props.mode,\n    format: props.format,\n    valueType: props.valueType,\n    enableTimePicker: props.enableTimePicker,\n  });\n\n  const inputRef = useRef<HTMLInputElement>();\n\n  const { value, onChange, time, setTime, month, setMonth, year, setYear, cacheValue, setCacheValue } =\n    useSingleValue(props);\n\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [isHoverCell, setIsHoverCell] = useState(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const [inputValue, setInputValue] = useState(formatDate(value, { format, targetFormat: format }));\n\n  // input 设置\n  const inputProps = {\n    ...props.inputProps,\n    ref: inputRef,\n    clearable: props.clearable,\n    prefixIcon: props.prefixIcon,\n    readonly: !props.allowInput,\n    placeholder: props.placeholder ?? globalDatePickerConfig.placeholder[props.mode],\n    suffixIcon: props.suffixIcon ?? <CalendarIcon />,\n    className: classNames({\n      [`${name}__input--placeholder`]: isHoverCell,\n    }),\n    onClear: ({ e }) => {\n      e.stopPropagation();\n      setPopupVisible(false);\n      onChange('', { dayjsValue: dayjs(''), trigger: 'clear' });\n    },\n    onBlur: (val: string, { e }) => {\n      props.onBlur?.({ value: val, e });\n    },\n    onFocus: (_: string, { e }) => {\n      props.onFocus?.({ value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      setInputValue(val);\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, format)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val, timeFormat);\n      !Number.isNaN(newYear) && setYear(newYear);\n      !Number.isNaN(newMonth) && setMonth(newMonth);\n      !Number.isNaN(newTime) && setTime(newTime);\n    },\n    onEnter: (val: string) => {\n      if (!isValidDate(val, format) && !isValidDate(value, format)) return;\n\n      setPopupVisible(false);\n      if (isValidDate(val, format)) {\n        onChange(formatDate(val, { format, targetFormat: valueType }), { dayjsValue: dayjs(val), trigger: 'enter' });\n      } else if (isValidDate(value, format)) {\n        setInputValue(formatDate(value, { format, targetFormat: format }));\n      } else {\n        setInputValue('');\n      }\n    },\n  };\n\n  // popup 设置\n  const popupProps = {\n    expandAnimation: true,\n    ...props.popupProps,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: classNames(props.popupProps?.overlayClassName, `${name}__panel-container`),\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (context.trigger === 'trigger-element-click') {\n        return setPopupVisible(true);\n      }\n      if (!visible) {\n        setIsHoverCell(false);\n      }\n      setPopupVisible(visible);\n    },\n  };\n\n  // 输入框响应 value 变化\n  useEffect(() => {\n    if (!value) {\n      setInputValue('');\n      return;\n    }\n    if (!isValidDate(value, valueType)) return;\n\n    setInputValue(formatDate(value, { format, targetFormat: format }));\n    // eslint-disable-next-line\n  }, [value]);\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    onChange,\n    setYear,\n    setMonth,\n    setTime,\n    setIsHoverCell,\n    setInputValue,\n    setPopupVisible,\n    setCacheValue,\n  };\n}\n"],"names":["useSingleInput","props","useConfig","classPrefix","globalDatePickerConfig","datePicker","useGlobalIcon","CalendarIcon","TdCalendarIcon","name","getDefaultFormat","mode","format","valueType","enableTimePicker","timeFormat","inputRef","useRef","useSingleValue","value","onChange","time","setTime","month","setMonth","year","setYear","cacheValue","setCacheValue","useState","popupVisible","setPopupVisible","isHoverCell","setIsHoverCell","formatDate","targetFormat","inputValue","setInputValue","inputProps","ref","clearable","prefixIcon","readonly","allowInput","placeholder","suffixIcon","React","createElement","className","classNames","onClear","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","onFocus","_","isValidDate","newMonth","newYear","newTime","formatTime","Number","isNaN","onEnter","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","context","useEffect"],"mappings":"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"}