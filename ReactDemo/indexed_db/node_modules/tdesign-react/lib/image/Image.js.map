{"version":3,"file":"Image.js","sources":["../../src/image/Image.tsx"],"sourcesContent":["import React, { Fragment, useEffect, useRef, useState } from 'react';\nimport classNames from 'classnames';\n\nimport { ImageErrorIcon as TdImageErrorIcon, ImageIcon as TdImageIcon } from 'tdesign-icons-react';\nimport observe from '../_common/js/utils/observe';\nimport useConfig from '../hooks/useConfig';\nimport { TdImageProps } from './type';\nimport { imageDefaultProps } from './defaultProps';\nimport Space from '../space';\n\nimport useGlobalIcon from '../hooks/useGlobalIcon';\n\nexport type ImageProps = TdImageProps;\n\nconst Image = (props: TdImageProps) => {\n  const {\n    className,\n    src,\n    style,\n    alt,\n    fit,\n    position,\n    shape,\n    placeholder,\n    loading,\n    error,\n    overlayTrigger,\n    overlayContent,\n    lazy,\n    gallery,\n    onLoad,\n    onError,\n    ...rest\n  } = props;\n\n  const { classPrefix } = useConfig();\n  const imageRef = useRef<HTMLDivElement>(null);\n\n  const { ImageErrorIcon, ImageIcon } = useGlobalIcon({\n    ImageErrorIcon: TdImageErrorIcon,\n    ImageIcon: TdImageIcon,\n  });\n\n  const [shouldLoad, setShouldLoad] = useState(!lazy);\n  const handleLoadImage = () => {\n    setShouldLoad(true);\n  };\n\n  const [isLoaded, setIsLoaded] = useState(false);\n  const handleLoad = () => {\n    setIsLoaded(true);\n    onLoad?.();\n  };\n\n  useEffect(() => {\n    if (!lazy || !imageRef?.current) return;\n\n    // https://stackoverflow.com/questions/67069827/cleanup-ref-issues-in-react\n    let observerRefValue = null;\n\n    const io = observe(imageRef.current, null, handleLoadImage, 0);\n    observerRefValue = imageRef.current;\n\n    return () => {\n      observerRefValue && io && io.unobserve(observerRefValue);\n    };\n  }, [lazy, imageRef]);\n\n  const [hasError, setHasError] = useState(false);\n  const handleError = () => {\n    setHasError(true);\n    onError?.();\n  };\n\n  const hasMouseEvent = overlayTrigger === 'hover';\n  const [shouldShowOverlay, setShouldShowOverlay] = useState(!hasMouseEvent);\n  const handleToggleOverlay = (overlay: boolean) => {\n    setShouldShowOverlay(overlay);\n  };\n  const renderOverlay = () => {\n    if (!overlayContent) return null;\n    return (\n      <div\n        className={classNames(\n          `${classPrefix}-image__overlay-content`,\n          !shouldShowOverlay && `${classPrefix}-image__overlay-content--hidden`,\n        )}\n      >\n        {overlayContent}\n      </div>\n    );\n  };\n\n  const renderPlaceholder = () => {\n    if (!placeholder) {\n      return null;\n    }\n    return <div className={`${classPrefix}-image__placeholder`}>{placeholder}</div>;\n  };\n\n  const renderGalleryShadow = () => {\n    if (!gallery) return null;\n    return <div className={`${classPrefix}-image__gallery-shadow`} />;\n  };\n\n  return (\n    <div\n      ref={imageRef}\n      className={classNames(\n        `${classPrefix}-image__wrapper`,\n        `${classPrefix}-image__wrapper--shape-${shape}`,\n        gallery && `${classPrefix}-image__wrapper--gallery`,\n        hasMouseEvent && `${classPrefix}-image__wrapper--need-hover`,\n        className,\n      )}\n      style={style}\n      {...(hasMouseEvent\n        ? {\n            onMouseEnter: () => handleToggleOverlay(true),\n            onMouseLeave: () => handleToggleOverlay(false),\n          }\n        : null)}\n      {...rest}\n    >\n      {renderPlaceholder()}\n\n      {renderGalleryShadow()}\n\n      {hasError || !shouldLoad ? (\n        <div className={`${classPrefix}-image`} />\n      ) : (\n        <Fragment>\n          <img\n            src={src}\n            onError={handleError}\n            onLoad={handleLoad}\n            className={classNames(\n              `${classPrefix}-image`,\n              `${classPrefix}-image--fit-${fit}`,\n              `${classPrefix}-image--position-${position}`,\n            )}\n            alt={alt}\n          />\n          {!isLoaded && (\n            <div className={`${classPrefix}-image__loading`}>\n              {loading || (\n                <Space direction=\"vertical\" size={8} align=\"center\">\n                  <ImageIcon size={24} />\n                  图片加载中\n                </Space>\n              )}\n            </div>\n          )}\n        </Fragment>\n      )}\n\n      {hasError && (\n        <div className={`${classPrefix}-image__error`}>\n          {error || (\n            <Space direction=\"vertical\" size={8} align=\"center\">\n              <ImageErrorIcon size={24} />\n              图片无法显示\n            </Space>\n          )}\n        </div>\n      )}\n\n      {renderOverlay()}\n    </div>\n  );\n};\n\nImage.displayName = 'Image';\nImage.defaultProps = imageDefaultProps;\n\nexport default Image;\n"],"names":["Image","props","className","src","style","alt","fit","position","shape","placeholder","loading","error","overlayTrigger","overlayContent","lazy","gallery","onLoad","onError","rest","useConfig","classPrefix","imageRef","useRef","useGlobalIcon","ImageErrorIcon","TdImageErrorIcon","ImageIcon","TdImageIcon","useState","shouldLoad","setShouldLoad","handleLoadImage","isLoaded","setIsLoaded","handleLoad","useEffect","current","observerRefValue","io","observe","unobserve","hasError","setHasError","handleError","hasMouseEvent","shouldShowOverlay","setShouldShowOverlay","handleToggleOverlay","overlay","renderOverlay","React","createElement","classNames","renderPlaceholder","renderGalleryShadow","ref","onMouseEnter","onMouseLeave","Fragment","Space","direction","size","align","displayName","defaultProps","imageDefaultProps"],"mappings":"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"}