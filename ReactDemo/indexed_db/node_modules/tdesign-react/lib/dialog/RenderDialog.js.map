{"version":3,"file":"RenderDialog.js","sources":["../../src/dialog/RenderDialog.tsx"],"sourcesContent":["import React, { useRef, CSSProperties, useEffect, forwardRef, useImperativeHandle } from 'react';\nimport { CSSTransition } from 'react-transition-group';\nimport classnames from 'classnames';\nimport Portal from '../common/Portal';\nimport noop from '../_util/noop';\nimport useLayoutEffect from '../_util/useLayoutEffect';\nimport { DialogProps } from './Dialog';\nimport useDialogEsc from '../_util/useDialogEsc';\nimport { dialogDefaultProps } from './defaultProps';\nimport { useLocaleReceiver } from '../locale/LocalReceiver';\n\nfunction GetCSSValue(v: string | number) {\n  return Number.isNaN(Number(v)) ? v : `${Number(v)}px`;\n}\nexport interface RenderDialogProps extends DialogProps {\n  prefixCls?: string;\n  classPrefix: string;\n}\n\nconst transitionTime = 300;\nlet mousePosition: { x: number; y: number } | null;\nconst getClickPosition = (e: MouseEvent) => {\n  mousePosition = {\n    x: e.clientX,\n    y: e.clientY,\n  };\n  setTimeout(() => {\n    mousePosition = null;\n  }, 100);\n};\nif (typeof window !== 'undefined' && window.document && window.document.documentElement) {\n  document.documentElement.addEventListener('click', getClickPosition, true);\n}\nconst RenderDialog = forwardRef((props: RenderDialogProps, ref: React.Ref<HTMLDivElement>) => {\n  const [local] = useLocaleReceiver('dialog');\n  const {\n    prefixCls,\n    attach,\n    visible,\n    mode,\n    zIndex,\n    showOverlay,\n    onEscKeydown = noop,\n    onClosed = noop,\n    onClose = noop,\n    onCloseBtnClick = noop,\n    onOverlayClick = noop,\n    onConfirm = noop,\n    preventScrollThrough,\n    closeBtn,\n    closeOnEscKeydown,\n    confirmOnEnter,\n    closeOnOverlayClick,\n    destroyOnClose,\n    showInAttachedElement,\n  } = props;\n\n  const wrap = useRef<HTMLDivElement>();\n  const dialog = useRef<HTMLDivElement>();\n  const dialogPosition = useRef<HTMLDivElement>();\n  const maskRef = useRef<HTMLDivElement>();\n  const portalRef = useRef<HTMLDivElement>();\n  const bodyOverflow = useRef<string>();\n  const bodyCssTextRef = useRef<string>();\n  const isModal = mode === 'modal';\n  const isNormal = mode === 'normal';\n  const canDraggable = props.draggable && mode === 'modeless';\n  const dialogOpenClass = `${prefixCls}__${mode}`;\n  useDialogEsc(visible, wrap);\n  useImperativeHandle(ref, () => wrap.current);\n  useLayoutEffect(() => {\n    bodyOverflow.current = document.body.style.overflow;\n    bodyCssTextRef.current = document.body.style.cssText;\n  }, []);\n\n  useLayoutEffect(() => {\n    if (visible) {\n      if (isModal && bodyOverflow.current !== 'hidden' && preventScrollThrough && !showInAttachedElement) {\n        const scrollWidth = window.innerWidth - document.body.offsetWidth;\n        // 减少回流\n        if (bodyCssTextRef.current === '') {\n          let bodyCssText = 'overflow: hidden;';\n          if (scrollWidth > 0) {\n            bodyCssText += `position: relative;width: calc(100% - ${scrollWidth}px);`;\n          }\n          document.body.style.cssText = bodyCssText;\n        } else {\n          if (scrollWidth > 0) {\n            document.body.style.width = `calc(100% - ${scrollWidth}px)`;\n            document.body.style.position = 'relative';\n          }\n          document.body.style.overflow = 'hidden';\n        }\n      }\n      if (wrap.current) {\n        wrap.current.focus();\n      }\n    } else if (isModal) {\n      const openDialogDom = document.querySelectorAll(`${prefixCls}__mode`);\n      if (openDialogDom.length < 1) {\n        document.body.style.cssText = bodyCssTextRef.current;\n      }\n    }\n\n    // 组件销毁后重置 body 样式\n    return () => {\n      if (isModal) {\n        // 此处只能查询 mode 模式的 dialog 个数 因为 modeless 会点击透传 normal 是正常文档流\n        const openDialogDom = document.querySelectorAll(`${prefixCls}__mode`);\n        if (openDialogDom.length < 1) {\n          document.body.style.cssText = bodyCssTextRef.current;\n          document.body.style.overflow = bodyOverflow.current;\n        }\n      } else {\n        document.body.style.cssText = bodyCssTextRef.current;\n        document.body.style.overflow = bodyOverflow.current;\n      }\n    };\n  }, [preventScrollThrough, attach, visible, mode, isModal, showInAttachedElement, prefixCls]);\n\n  useEffect(() => {\n    // 动画渲染初始位置\n    if (visible) {\n      if (mousePosition && dialog.current) {\n        dialog.current.style.transformOrigin = `${mousePosition.x - dialog.current.offsetLeft}px ${\n          mousePosition.y - dialog.current.offsetTop\n        }px`;\n      }\n    }\n  }, [visible]);\n\n  const onAnimateLeave = () => {\n    if (wrap.current) {\n      wrap.current.style.display = 'none';\n    }\n    if (isModal && preventScrollThrough) {\n      // 还原 body 的滚动条\n      const openDialogDom = document.querySelectorAll(`${prefixCls}__mode`);\n      if (isModal && openDialogDom.length < 1) {\n        document.body.style.overflow = bodyOverflow.current;\n      }\n    }\n    if (!isModal) {\n      // 关闭弹窗 清空拖拽设置的相关 css\n      const { style } = dialog.current;\n      style.position = 'relative';\n      style.left = 'unset';\n      style.top = 'unset';\n    }\n    onClosed && onClosed();\n  };\n\n  const onMaskClick = (e: React.MouseEvent<HTMLDivElement>) => {\n    if (showOverlay && (closeOnOverlayClick ?? local.closeOnOverlayClick)) {\n      if (e.target === dialogPosition.current) {\n        onOverlayClick({ e });\n        onClose({ e, trigger: 'overlay' });\n      }\n    }\n  };\n\n  const handleCloseBtnClick = (e: React.MouseEvent<HTMLDivElement>) => {\n    onCloseBtnClick({ e });\n    onClose({ e, trigger: 'close-btn' });\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {\n    // https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/keyCode\n    if (e.code === 'Escape') {\n      e.stopPropagation();\n      onEscKeydown({ e });\n      if (closeOnEscKeydown ?? local.closeOnEscKeydown) {\n        onClose({ e, trigger: 'esc' });\n      }\n    } else if (e.code === 'Enter' || e.code === 'NumpadEnter') {\n      // 回车键触发点击确认事件\n      e.stopPropagation();\n      if (confirmOnEnter) {\n        onConfirm({ e });\n      }\n    }\n  };\n\n  const renderDialog = () => {\n    const dest: any = {};\n    if (props.width !== undefined) {\n      dest.width = GetCSSValue(props.width);\n    }\n    // normal 场景下，需要设置 zindex 为auto 避免出现多个 dialog，normal 出现在最上层\n    if (props.mode === 'normal') {\n      dest.zIndex = 'auto';\n    }\n    const footer = props.footer ? <div className={`${prefixCls}__footer`}>{props.footer}</div> : null;\n\n    const { header } = props;\n\n    const body = <div className={`${prefixCls}__body`}>{props.body || props.children}</div>;\n\n    const closer = closeBtn && (\n      <span onClick={handleCloseBtnClick} className={`${prefixCls}__close`}>\n        {closeBtn}\n      </span>\n    );\n    const validWindow = typeof window === 'object';\n\n    const screenHeight = validWindow ? window.innerHeight || document.documentElement.clientHeight : undefined;\n    const screenWidth = validWindow ? window.innerWidth || document.documentElement.clientWidth : undefined;\n\n    const style = { ...dest, ...props.style };\n    let dialogOffset = { x: 0, y: 0 };\n    // 拖拽代码实现部分\n    const onDialogMove = (e: MouseEvent) => {\n      const { style, offsetWidth, offsetHeight } = dialog.current;\n\n      let diffX = e.clientX - dialogOffset.x;\n      let diffY = e.clientY - dialogOffset.y;\n      // 拖拽上左边界限制\n      if (diffX < 0) diffX = 0;\n      if (diffY < 0) diffY = 0;\n      if (screenWidth - offsetWidth - diffX < 0) diffX = screenWidth - offsetWidth;\n      if (screenHeight - offsetHeight - diffY < 0) diffY = screenHeight - offsetHeight;\n      style.position = 'absolute';\n      style.left = `${diffX}px`;\n      style.top = `${diffY}px`;\n    };\n\n    const onDialogMoveEnd = () => {\n      dialog.current.style.cursor = 'default';\n      document.removeEventListener('mousemove', onDialogMove);\n      document.removeEventListener('mouseup', onDialogMoveEnd);\n    };\n\n    const onDialogMoveStart = (e: React.MouseEvent<HTMLDivElement>) => {\n      // 阻止事件冒泡\n      if (canDraggable && e.currentTarget === e.target) {\n        const { offsetLeft, offsetTop, offsetHeight, offsetWidth } = dialog.current;\n        // 如果弹出框超出屏幕范围 不能进行拖拽\n        if (offsetWidth > screenWidth || offsetHeight > screenHeight) return;\n        dialog.current.style.cursor = 'move';\n        // 计算鼠标\n        const diffX = e.clientX - offsetLeft;\n        const diffY = e.clientY - offsetTop;\n        dialogOffset = {\n          x: diffX,\n          y: diffY,\n        };\n\n        document.addEventListener('mousemove', onDialogMove);\n        document.addEventListener('mouseup', onDialogMoveEnd);\n      }\n    };\n    // 顶部定位实现\n    const positionStyle: any = {};\n    if (props.top) {\n      const topValue = GetCSSValue(props.top);\n      positionStyle.paddingTop = topValue;\n    }\n    // 此处获取定位方式 top 优先级较高 存在时 默认使用 top 定位\n    const positionClass = classnames(\n      `${prefixCls}__position`,\n      { [`${prefixCls}--top`]: !!props.top },\n      `${props.placement && !props.top ? `${prefixCls}--${props.placement}` : ''}`,\n    );\n    const dialogElement = (\n      <div className={isNormal ? '' : `${prefixCls}__wrap`}>\n        <div className={isNormal ? '' : positionClass} style={positionStyle} onClick={onMaskClick} ref={dialogPosition}>\n          <div\n            ref={dialog}\n            style={style}\n            className={classnames(`${prefixCls}`, `${prefixCls}--default`)}\n            onMouseDown={onDialogMoveStart}\n          >\n            {closer}\n            {header}\n            {body}\n            {footer}\n          </div>\n        </div>\n      </div>\n    );\n\n    return (\n      <CSSTransition\n        in={props.visible}\n        appear\n        mountOnEnter\n        unmountOnExit={destroyOnClose}\n        timeout={transitionTime}\n        classNames={`${prefixCls}-zoom`}\n        onEntered={props.onOpened}\n        onExited={onAnimateLeave}\n        nodeRef={dialog}\n      >\n        {dialogElement}\n      </CSSTransition>\n    );\n  };\n\n  const renderMask = () => {\n    let maskElement;\n    if (showOverlay) {\n      maskElement = (\n        <CSSTransition\n          in={visible}\n          appear\n          timeout={transitionTime}\n          classNames={`${prefixCls}-fade`}\n          mountOnEnter\n          unmountOnExit\n          nodeRef={maskRef}\n        >\n          <div ref={maskRef} className={`${prefixCls}__mask`} />\n        </CSSTransition>\n      );\n    }\n    return maskElement;\n  };\n\n  const render = () => {\n    const style: CSSProperties = {};\n    if (visible) {\n      style.display = 'block';\n    }\n    const wrapStyle = {\n      ...style,\n      zIndex,\n    };\n\n    const dialogBody = renderDialog();\n    const wrapClass = classnames(\n      props.className,\n      `${prefixCls}__ctx`,\n      !isNormal ? `${prefixCls}__ctx--fixed` : '',\n      visible ? dialogOpenClass : '',\n      isModal && showInAttachedElement ? `${prefixCls}__ctx--absolute` : '',\n      props.mode === 'modeless' ? `${prefixCls}__ctx--modeless` : '',\n    );\n    // 如果不是 modal 模式 默认没有 mask 也就没有相关点击 mask 事件\n    const dialog = (\n      <div ref={wrap} className={wrapClass} style={wrapStyle} onKeyDown={handleKeyDown} tabIndex={0}>\n        {mode === 'modal' && renderMask()}\n        {dialogBody}\n      </div>\n    );\n\n    let dom = null;\n    if (visible || wrap.current) {\n      // normal 模式 attach 无效\n      if (attach === '' || isNormal) {\n        dom = dialog;\n      } else {\n        dom = (\n          <CSSTransition\n            in={visible}\n            appear\n            timeout={transitionTime}\n            mountOnEnter\n            unmountOnExit={destroyOnClose}\n            nodeRef={portalRef}\n          >\n            <Portal attach={attach} ref={portalRef}>\n              {dialog}\n            </Portal>\n          </CSSTransition>\n        );\n      }\n    }\n    return dom;\n  };\n\n  return render();\n});\n\nRenderDialog.defaultProps = dialogDefaultProps;\n\nexport default RenderDialog;\n"],"names":["GetCSSValue","v","Number","isNaN","transitionTime","mousePosition","getClickPosition","e","x","clientX","y","clientY","setTimeout","window","document","documentElement","addEventListener","RenderDialog","forwardRef","props","ref","useLocaleReceiver","local","prefixCls","attach","visible","mode","zIndex","showOverlay","onEscKeydown","noop","onClosed","onClose","onCloseBtnClick","onOverlayClick","onConfirm","preventScrollThrough","closeBtn","closeOnEscKeydown","confirmOnEnter","closeOnOverlayClick","destroyOnClose","showInAttachedElement","wrap","useRef","dialog","dialogPosition","maskRef","portalRef","bodyOverflow","bodyCssTextRef","isModal","isNormal","canDraggable","draggable","dialogOpenClass","useDialogEsc","useImperativeHandle","current","useLayoutEffect","body","style","overflow","cssText","scrollWidth","innerWidth","offsetWidth","bodyCssText","width","position","focus","openDialogDom","querySelectorAll","length","useEffect","transformOrigin","offsetLeft","offsetTop","onAnimateLeave","display","left","top","onMaskClick","target","trigger","handleCloseBtnClick","handleKeyDown","code","stopPropagation","renderDialog","dest","footer","React","createElement","className","header","children","closer","onClick","validWindow","screenHeight","innerHeight","clientHeight","screenWidth","clientWidth","dialogOffset","onDialogMove","offsetHeight","diffX","diffY","onDialogMoveEnd","cursor","removeEventListener","onDialogMoveStart","currentTarget","positionStyle","topValue","paddingTop","positionClass","classnames","placement","dialogElement","onMouseDown","CSSTransition","appear","mountOnEnter","unmountOnExit","timeout","classNames","onEntered","onOpened","onExited","nodeRef","renderMask","maskElement","render","wrapStyle","dialogBody","wrapClass","onKeyDown","tabIndex","dom","Portal","defaultProps","dialogDefaultProps"],"mappings":"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"}