{"version":3,"file":"useEditableRow.js","sources":["../../../src/table/hooks/useEditableRow.ts"],"sourcesContent":["import { useState, useMemo } from 'react';\nimport get from 'lodash/get';\nimport isFunction from 'lodash/isFunction';\nimport { PrimaryTableProps } from '../interface';\nimport { validate } from '../../form/formModel';\nimport { AllValidateResult } from '../../form';\nimport { getEditableKeysMap } from '../utils';\nimport { PrimaryTableRowEditContext, TableRowData, TableErrorListMap } from '../type';\n\nexport type ErrorListObjectType = PrimaryTableRowEditContext<TableRowData> & { errorList: AllValidateResult[] };\n\nexport interface TablePromiseErrorData {\n  errors: ErrorListObjectType[];\n  errorMap: TableErrorListMap;\n}\n\nconst cellRuleMap = new Map<any, PrimaryTableRowEditContext<TableRowData>[]>();\n\nexport function useEditableRow(props: PrimaryTableProps) {\n  const { editableRowKeys } = props;\n  // 校验不通过的错误信息，其中 key 值为 [rowValue, col.colKey].join('__')\n  const [errorListMap, setErrorListMap] = useState<TableErrorListMap>({});\n  const editableKeysMap = useMemo(\n    () => editableRowKeys && getEditableKeysMap(editableRowKeys, props.data, props.rowKey || 'id'),\n    [editableRowKeys, props.data, props.rowKey],\n  );\n\n  const getErrorListMapByErrors = (errors: ErrorListObjectType[]): TableErrorListMap => {\n    const errorMap: TableErrorListMap = {};\n    errors.forEach(({ row, col, errorList }) => {\n      const rowValue = get(row, props.rowKey || 'id');\n      const key = [rowValue, col.colKey].join('__');\n      if (errorList?.length) {\n        errorMap[key] = errorList;\n      } else {\n        delete errorMap[key];\n      }\n    });\n    return errorMap;\n  };\n\n  // 校验一行的数据\n  const validateOneRowData = (rowValue: any) => {\n    const rowRules = cellRuleMap.get(rowValue);\n    if (!rowRules) return;\n    const list = rowRules.map(\n      (item) =>\n        new Promise<ErrorListObjectType>((resolve) => {\n          const { editedRow, col } = item;\n          const rules = isFunction(col.edit.rules) ? col.edit.rules(item) : col.edit.rules;\n          if (!col.edit || !rules || !rules) {\n            resolve({ ...item, errorList: [] });\n            return;\n          }\n          validate(editedRow[col.colKey], rules).then((r) => {\n            resolve({ ...item, errorList: r.filter((t) => !t.result) });\n          });\n        }),\n    );\n    return new Promise<TablePromiseErrorData>((resolve, reject) => {\n      Promise.all(list).then((errors) => {\n        resolve({\n          errors: errors.filter((t) => t.errorList?.length),\n          errorMap: getErrorListMapByErrors(errors),\n        });\n      }, reject);\n    });\n  };\n\n  /**\n   * 校验表格单行数据（对外开放方法，修改时需慎重）\n   * @param rowValue 行唯一标识\n   */\n  const validateRowData = (rowValue: any) =>\n    new Promise((resolve, reject) => {\n      validateOneRowData(rowValue).then(({ errors, errorMap }) => {\n        setErrorListMap(errorMap);\n        // 缺少校验文本显示\n        const tTrigger = 'parent';\n        props.onRowValidate?.({ trigger: tTrigger, result: errors });\n        resolve({ trigger: tTrigger, result: errors });\n      }, reject);\n    });\n\n  /**\n   * 校验整个表格数据（对外开放方法，修改时需慎重）\n   */\n  const validateTableData = () => {\n    const promiseList: Promise<TablePromiseErrorData>[] = [];\n    const data = props.data || [];\n    for (let i = 0, len = data.length; i < len; i++) {\n      const rowValue = get(data[i], props.rowKey || 'id');\n      promiseList.push(validateOneRowData(rowValue));\n    }\n    return new Promise((resolve, reject) => {\n      Promise.all(promiseList).then((rList) => {\n        const allErrorListMap: TableErrorListMap = {};\n        rList.forEach(({ errorMap } = { errors: [], errorMap: {} }) => {\n          errorMap && Object.assign(allErrorListMap, errorMap);\n        });\n        setErrorListMap(allErrorListMap);\n        props.onValidate?.({ result: allErrorListMap });\n        resolve({ result: allErrorListMap });\n      }, reject);\n    });\n  };\n\n  const onRuleChange = (context: PrimaryTableRowEditContext<TableRowData>) => {\n    // 编辑行，预存校验信息，方便最终校验\n    if (props.editableRowKeys) {\n      const rowValue = get(context.row, props.rowKey || 'id');\n      const rules = cellRuleMap.get(rowValue);\n      if (rules) {\n        const index = rules.findIndex((t) => t.col.colKey === context.col.colKey);\n        if (index === -1) {\n          rules.push(context);\n        } else {\n          rules[index] = context;\n        }\n        cellRuleMap.set(rowValue, rules);\n      } else {\n        cellRuleMap.set(rowValue, [context]);\n      }\n    }\n  };\n\n  const clearValidateData = () => {\n    setErrorListMap({});\n  };\n\n  return {\n    errorListMap,\n    editableKeysMap,\n    validateRowData,\n    validateTableData,\n    clearValidateData,\n    onRuleChange,\n  };\n}\n"],"names":["cellRuleMap","Map","useEditableRow","props","editableRowKeys","useState","errorListMap","setErrorListMap","editableKeysMap","useMemo","getEditableKeysMap","data","rowKey","getErrorListMapByErrors","errors","errorMap","forEach","row","col","errorList","rowValue","get","key","colKey","join","length","validateOneRowData","rowRules","list","map","item","Promise","resolve","editedRow","rules","isFunction","edit","validate","then","r","filter","t","result","reject","all","validateRowData","tTrigger","onRowValidate","trigger","validateTableData","promiseList","i","len","push","rList","allErrorListMap","Object","assign","onValidate","onRuleChange","context","index","findIndex","set","clearValidateData"],"mappings":"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"}