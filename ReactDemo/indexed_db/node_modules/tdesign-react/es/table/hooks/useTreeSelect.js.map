{"version":3,"file":"useTreeSelect.js","sources":["../../../src/table/hooks/useTreeSelect.tsx"],"sourcesContent":["import { useMemo, useState, useEffect } from 'react';\nimport get from 'lodash/get';\nimport intersection from 'lodash/intersection';\nimport { TdEnhancedTableProps, TdPrimaryTableProps, TableRowData, PrimaryTableCol } from '../type';\nimport { KeysType, TableTreeDataMap, TreeDataMapType } from '../../_common/js/table/tree-store';\nimport useControlled from '../../hooks/useControlled';\n\nexport interface GetChildrenDataReturnValue {\n  allChildren: Array<any>;\n  allChildrenKeys: Array<string | number>;\n  leafNodeKeys: Array<string | number>;\n}\n\n// 保存子节点信息，避免重复计算\nexport const childrenMap = new Map();\n\nexport function getChildrenData(\n  treeDataMap: TreeDataMapType,\n  data: TableRowData,\n  keys: { childrenKey: string; rowKey: string },\n  r?: GetChildrenDataReturnValue,\n): GetChildrenDataReturnValue {\n  if (childrenMap.get(data)) return childrenMap.get(data);\n  const result = r || { allChildren: [], allChildrenKeys: [], leafNodeKeys: [] };\n  const children = get(data, keys.childrenKey);\n  if (!children || !children.length) return result;\n  const selectableChildren = children.filter(\n    (item: TableRowData) => !treeDataMap.get(get(item, keys.rowKey))?.disabled,\n  );\n  result.allChildren = [...new Set(result.allChildren.concat(selectableChildren))];\n  for (let i = 0, len = children.length; i < len; i++) {\n    const tItem = children[i];\n    const c = get(tItem, keys.childrenKey);\n    if (c?.length) {\n      const nextLevelData = getChildrenData(treeDataMap, tItem, keys, result);\n      result.allChildren = [...new Set(result.allChildren.concat(nextLevelData.allChildren))];\n    }\n  }\n  // 避免使用 forEach，减少上下文消耗\n  for (let i = 0, len = result.allChildren.length; i < len; i++) {\n    const item = result.allChildren[i];\n    const children = get(item, keys.childrenKey);\n    const rowValue = get(item, keys.rowKey);\n    result.allChildrenKeys.push(rowValue);\n    if (!children || !children.length) {\n      result.leafNodeKeys.push(rowValue);\n    }\n  }\n  result.allChildrenKeys = [...new Set(result.allChildrenKeys)];\n  result.leafNodeKeys = [...new Set(result.leafNodeKeys)];\n  return result;\n}\n\nexport interface RemoveParams {\n  // 当前选中的数据\n  selectedRowKeys: Array<string | number>;\n  // 需要移除的数据\n  removeKeys: Array<string | number>;\n}\n\nexport interface RemainData {\n  data: Array<any>;\n  keys: Array<string | number>;\n}\n\nexport function removeChildrenKeys(p: RemoveParams, r?: RemainData): RemainData {\n  const { selectedRowKeys, removeKeys } = p;\n  const result = r || { data: [], keys: [] };\n  for (let i = 0, len = selectedRowKeys.length; i < len; i++) {\n    const key = selectedRowKeys[i];\n    if (!removeKeys.includes(key)) {\n      result.keys.push(key);\n    }\n  }\n  return result;\n}\n\nexport interface GetKeyDataParams {\n  treeDataMap: TreeDataMapType;\n  data: Array<any>;\n  column: PrimaryTableCol;\n  keys: KeysType;\n}\n\nexport interface GetRowDataParams {\n  treeDataMap: TreeDataMapType;\n  selectedRowKeys: Array<string | number>;\n}\n\nexport function getRowDataByKeys(p: GetRowDataParams) {\n  const { treeDataMap, selectedRowKeys } = p;\n  const result = [];\n  for (let i = 0, len = selectedRowKeys.length; i < len; i++) {\n    const key = selectedRowKeys[i];\n    result.push(treeDataMap.get(key));\n  }\n  return result;\n}\n\ntype SelectChangeParams = Parameters<TdPrimaryTableProps['onSelectChange']>;\n\nexport default function useTreeSelect(props: TdEnhancedTableProps, treeDataMap: TableTreeDataMap) {\n  const { tree, rowKey, data, indeterminateSelectedRowKeys } = props;\n  // 半选状态的节点：子节点选中至少一个，且没有全部选中\n  const [tIndeterminateSelectedRowKeys, setTIndeterminateSelectedRowKeys] = useState([]);\n  // eslint-disable-next-line\n  const [tSelectedRowKeys, setTSelectedRowKeys] = useControlled(props, 'selectedRowKeys', props.onSelectChange, {\n    defaultSelectedRowKeys: props.defaultSelectedRowKeys || [],\n  });\n\n  const rowDataKeys = useMemo(\n    () => ({\n      rowKey: rowKey || 'id',\n      childrenKey: tree?.childrenKey || 'children',\n    }),\n    [rowKey, tree?.childrenKey],\n  );\n\n  useEffect(() => {\n    if (!tree || !treeDataMap.size || tree.checkStrictly) return;\n    updateIndeterminateState();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [tSelectedRowKeys, data, tree, treeDataMap]);\n\n  function updateIndeterminateState() {\n    if (!tree || tree.checkStrictly) return;\n    if (!tSelectedRowKeys.length) {\n      setTIndeterminateSelectedRowKeys([]);\n      return;\n    }\n    const keys: Array<string | number> = [];\n    const parentMap: { [key: string | number]: any[] } = {};\n    for (let i = 0, len = tSelectedRowKeys.length; i < len; i++) {\n      const rowValue = tSelectedRowKeys[i];\n      const state = treeDataMap.get(rowValue);\n      const children = get(state.row, rowDataKeys.childrenKey);\n      // 根据选中的叶子结点计算父节点半选状态\n      if (!children || !children.length) {\n        let parentTmp = state.parent;\n        while (parentTmp) {\n          if (!parentMap[parentTmp.id]) {\n            parentMap[parentTmp.id] = [];\n          }\n          parentMap[parentTmp.id].push(state.row);\n          const checkedLength = parentMap[parentTmp.id].length;\n          const { allChildrenKeys } = getChildrenData(treeDataMap, parentTmp.row, rowDataKeys);\n          const parentTmpIndex = keys.indexOf(parentTmp.id);\n          const selectedIndex = tSelectedRowKeys.indexOf(parentTmp.id);\n          if (checkedLength > 0 && checkedLength < allChildrenKeys.length && selectedIndex === -1) {\n            parentTmpIndex === -1 && keys.push(parentTmp.id);\n          } else {\n            parentTmpIndex !== -1 && keys.splice(parentTmpIndex, 1);\n          }\n          parentTmp = parentTmp.parent;\n        }\n      }\n    }\n    setTIndeterminateSelectedRowKeys(keys);\n  }\n\n  function updateParentCheckedState(\n    selectedKeys: (string | number)[],\n    currentRowKey: string | number,\n    type: 'check' | 'uncheck',\n  ) {\n    if (!tree || tree.checkStrictly) return;\n    const keys = [...selectedKeys];\n    const state = treeDataMap.get(currentRowKey);\n    let parentTmp = state.parent;\n    while (parentTmp) {\n      const { leafNodeKeys } = getChildrenData(treeDataMap, parentTmp.row, rowDataKeys);\n      const checkedChildrenKeys = intersection(leafNodeKeys, selectedKeys);\n      const selectedIndex = keys.indexOf(parentTmp.id);\n      if (type === 'uncheck') {\n        selectedIndex !== -1 && keys.splice(selectedIndex, 1);\n      } else if (checkedChildrenKeys.length === leafNodeKeys.length) {\n        selectedIndex === -1 && keys.push(parentTmp.id);\n      }\n      parentTmp = parentTmp.parent;\n    }\n    return keys;\n  }\n\n  function onInnerSelectChange(rowKeys: SelectChangeParams[0], extraData: SelectChangeParams[1]) {\n    if (!tree || tree.checkStrictly) {\n      setTSelectedRowKeys(rowKeys, extraData);\n      return;\n    }\n    if (extraData.currentRowKey === 'CHECK_ALL_BOX') {\n      handleSelectAll(extraData);\n    } else {\n      handleSelect(rowKeys, extraData);\n    }\n  }\n\n  function handleSelectAll(extraData: SelectChangeParams[1]) {\n    const newRowKeys: Array<string | number> = [];\n    const newRowData: TableRowData[] = [];\n    if (extraData?.type === 'check') {\n      const arr = [...treeDataMap.values()];\n      for (let i = 0, len = arr.length; i < len; i++) {\n        const item = arr[i];\n        if (!item?.disabled) {\n          newRowData.push(item.row);\n          newRowKeys.push(get(item.row, rowDataKeys.rowKey));\n        }\n      }\n    }\n    const newExtraData = {\n      ...extraData,\n      selectedRowData: newRowData || [],\n    };\n    setTSelectedRowKeys(newRowKeys, newExtraData);\n  }\n\n  function handleSelect(rowKeys: SelectChangeParams[0], extraData: SelectChangeParams[1]) {\n    let newRowKeys = [...rowKeys];\n    if (tree.checkStrictly === false) {\n      if (extraData.type === 'check') {\n        const result = getChildrenData(treeDataMap, extraData.currentRowData, rowDataKeys);\n        const { allChildrenKeys } = result;\n        childrenMap.set(extraData.currentRowData, result);\n        newRowKeys = [...new Set(newRowKeys.concat(allChildrenKeys))];\n      } else if (extraData.type === 'uncheck') {\n        const children = getChildrenData(treeDataMap, extraData.currentRowData, rowDataKeys);\n        const result = removeChildrenKeys({\n          selectedRowKeys: rowKeys,\n          removeKeys: children.allChildrenKeys,\n        });\n        newRowKeys = result.keys;\n      }\n    }\n    newRowKeys = updateParentCheckedState(newRowKeys, extraData.currentRowKey, extraData.type);\n    const newRowData = getRowDataByKeys({ treeDataMap, selectedRowKeys: newRowKeys });\n    const newExtraData = {\n      ...extraData,\n      selectedRowData: newRowData,\n    };\n    setTSelectedRowKeys(newRowKeys, newExtraData);\n  }\n\n  return {\n    // 如果存在受控属性 indeterminateSelectedRowKeys 则优先使用；否则使用内部状态：tIndeterminateSelectedRowKeys\n    tIndeterminateSelectedRowKeys: indeterminateSelectedRowKeys || tIndeterminateSelectedRowKeys,\n    onInnerSelectChange,\n  };\n}\n"],"names":["childrenMap","Map","getChildrenData","treeDataMap","data","keys","r","get","result","allChildren","allChildrenKeys","leafNodeKeys","children","childrenKey","length","selectableChildren","filter","item","rowKey","disabled","Set","concat","i","len","tItem","c","nextLevelData","rowValue","push","removeChildrenKeys","p","selectedRowKeys","removeKeys","key","includes","getRowDataByKeys","useTreeSelect","props","tree","indeterminateSelectedRowKeys","useState","tIndeterminateSelectedRowKeys","setTIndeterminateSelectedRowKeys","useControlled","onSelectChange","defaultSelectedRowKeys","tSelectedRowKeys","setTSelectedRowKeys","rowDataKeys","useMemo","useEffect","size","checkStrictly","updateIndeterminateState","parentMap","state","row","parentTmp","parent","id","checkedLength","parentTmpIndex","indexOf","selectedIndex","splice","updateParentCheckedState","selectedKeys","currentRowKey","type","checkedChildrenKeys","intersection","onInnerSelectChange","rowKeys","extraData","handleSelectAll","handleSelect","newRowKeys","newRowData","arr","values","newExtraData","selectedRowData","currentRowData","set"],"mappings":"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"}