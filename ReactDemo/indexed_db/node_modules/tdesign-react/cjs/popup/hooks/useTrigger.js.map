{"version":3,"file":"useTrigger.js","sources":["../../../src/popup/hooks/useTrigger.tsx"],"sourcesContent":["import React, { useRef, useEffect, isValidElement } from 'react';\nimport { isFragment } from 'react-is';\nimport classNames from 'classnames';\nimport useConfig from '../../hooks/useConfig';\nimport { supportRef, getRefDom } from '../utils/ref';\nimport composeRefs from '../../_util/composeRefs';\n\nconst ESC_KEY = 'Escape';\n\nexport default function useTrigger({ content, disabled, trigger, visible, onVisibleChange, triggerRef }) {\n  const { classPrefix } = useConfig();\n  const hasPopupMouseDown = useRef(false);\n  const mouseDownTimer = useRef(0);\n  const triggerDataKey = useRef(`${classPrefix}-popup--${Math.random().toFixed(10)}`);\n\n  // 禁用和无内容时不展示\n  const shouldToggle = !disabled && content;\n\n  // 点击 trigger overlay 以外的元素关闭\n  useEffect(() => {\n    if (!shouldToggle) return;\n\n    const handleDocumentClick = (e: any) => {\n      if (getRefDom(triggerRef).contains(e.target) || hasPopupMouseDown.current) {\n        return;\n      }\n      visible && onVisibleChange(false, { e, trigger: 'document' });\n    };\n    document.addEventListener('mousedown', handleDocumentClick);\n    document.addEventListener('touchend', handleDocumentClick);\n    return () => {\n      document.removeEventListener('mousedown', handleDocumentClick);\n      document.removeEventListener('touchend', handleDocumentClick);\n    };\n  }, [shouldToggle, visible, onVisibleChange, triggerRef]);\n\n  // 弹出内容交互处理\n  function getPopupProps(): any {\n    if (!shouldToggle) return {};\n\n    return {\n      onMouseEnter: (e: MouseEvent) => {\n        if (trigger === 'hover') {\n          onVisibleChange(true, { e, trigger: 'trigger-element-hover' });\n        }\n      },\n      onMouseLeave: (e: MouseEvent) => {\n        if (trigger === 'hover') {\n          onVisibleChange(false, { e, trigger: 'trigger-element-hover' });\n        }\n      },\n      onMouseDown: () => {\n        clearTimeout(mouseDownTimer.current);\n        hasPopupMouseDown.current = true;\n        mouseDownTimer.current = window.setTimeout(() => {\n          hasPopupMouseDown.current = false;\n        });\n      },\n      onTouchEnd: () => {\n        clearTimeout(mouseDownTimer.current);\n        hasPopupMouseDown.current = true;\n        mouseDownTimer.current = window.setTimeout(() => {\n          hasPopupMouseDown.current = false;\n        });\n      },\n    };\n  }\n\n  // 整理 trigger props\n  function getTriggerProps(triggerNode: React.ReactElement) {\n    if (!shouldToggle) return {};\n\n    const triggerProps: any = {\n      className: visible\n        ? classNames(triggerNode.props.className, `${classPrefix}-popup-open`)\n        : triggerNode.props.className,\n      onClick: (e: MouseEvent) => {\n        if (trigger === 'click') {\n          onVisibleChange(!visible, { e, trigger: 'trigger-element-click' });\n        }\n        triggerNode.props.onClick?.(e);\n      },\n      onTouchStart: (e: TouchEvent) => {\n        if (trigger === 'hover') {\n          onVisibleChange(true, { e, trigger: 'trigger-element-hover' });\n        }\n        triggerNode.props.onTouchStart?.(e);\n      },\n      onMouseEnter: (e: MouseEvent) => {\n        if (trigger === 'hover') {\n          onVisibleChange(true, { e, trigger: 'trigger-element-hover' });\n        }\n        triggerNode.props.onMouseEnter?.(e);\n      },\n      onMouseLeave: (e: MouseEvent) => {\n        if (trigger === 'hover') {\n          onVisibleChange(false, { e, trigger: 'trigger-element-hover' });\n        }\n        triggerNode.props.onMouseLeave?.(e);\n      },\n      onFocus: (...args: any) => {\n        if (trigger === 'focus') {\n          onVisibleChange(true, { trigger: 'trigger-element-focus' });\n        }\n        triggerNode.props.onFocus?.(...args);\n      },\n      onBlur: (...args: any) => {\n        if (trigger === 'focus') {\n          onVisibleChange(false, { trigger: 'trigger-element-blur' });\n        }\n        triggerNode.props.onBlur?.(...args);\n      },\n      onContextMenu: (e: MouseEvent) => {\n        if (trigger === 'context-menu') {\n          onVisibleChange(true, { e, trigger: 'context-menu' });\n        }\n        triggerNode.props.onContextMenu?.(e);\n      },\n      onKeyDown: (e: KeyboardEvent) => {\n        if (e?.key === ESC_KEY) {\n          onVisibleChange(false, { e, trigger: 'keydown-esc' });\n        }\n        triggerNode.props.onKeyDown?.(e);\n      },\n    };\n\n    if (supportRef(triggerNode)) {\n      triggerProps.ref = composeRefs(triggerRef, (triggerNode as any).ref);\n    } else {\n      // 标记 trigger 元素\n      triggerProps['data-popup'] = triggerDataKey.current;\n    }\n\n    return triggerProps;\n  }\n\n  // 整理 trigger 元素\n  function getTriggerNode(children: React.ReactNode) {\n    const triggerNode =\n      isValidElement(children) && !isFragment(children) ? (\n        children\n      ) : (\n        <span className={`${classPrefix}-trigger`}>{children}</span>\n      );\n\n    return React.cloneElement(triggerNode, getTriggerProps(triggerNode));\n  }\n\n  // ref 透传失败时使用 dom 查找\n  function getTriggerDom() {\n    return document.querySelector(`[data-popup=\"${triggerDataKey.current}\"]`);\n  }\n\n  return {\n    getTriggerNode,\n    getPopupProps,\n    getTriggerDom,\n  };\n}\n"],"names":["ESC_KEY","useTrigger","content","disabled","trigger","visible","onVisibleChange","triggerRef","useConfig","classPrefix","hasPopupMouseDown","useRef","mouseDownTimer","triggerDataKey","Math","random","toFixed","shouldToggle","useEffect","handleDocumentClick","e","getRefDom","contains","target","current","document","addEventListener","removeEventListener","getPopupProps","onMouseEnter","onMouseLeave","onMouseDown","clearTimeout","window","setTimeout","onTouchEnd","getTriggerProps","triggerNode","triggerProps","className","classNames","props","onClick","onTouchStart","onFocus","args","onBlur","onContextMenu","onKeyDown","key","supportRef","ref","composeRefs","getTriggerNode","children","isValidElement","isFragment","React","createElement","cloneElement","getTriggerDom","querySelector"],"mappings":"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"}