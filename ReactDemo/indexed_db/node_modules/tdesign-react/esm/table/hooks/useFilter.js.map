{"version":3,"file":"useFilter.js","sources":["../../../src/table/hooks/useFilter.tsx"],"sourcesContent":["import React, { useEffect, useState, MutableRefObject } from 'react';\nimport useClassName from './useClassName';\nimport TButton from '../../button';\nimport { TdPrimaryTableProps, PrimaryTableCol, TableRowData, FilterValue } from '../type';\nimport useControlled from '../../hooks/useControlled';\nimport TableFilterController from '../FilterController';\nimport { useLocaleReceiver } from '../../locale/LocalReceiver';\n\n// 筛选条件不为空，才需要显示筛选结果行\nfunction filterEmptyData(data: FilterValue) {\n  const newFilterValue: FilterValue = {};\n  Object.keys(data).forEach((key) => {\n    const item = data[key];\n    const isArrayTrue = item instanceof Array && item.length;\n    const isObject = typeof item === 'object' && !(item instanceof Array);\n    const isObjectTrue = isObject && Object.keys(item).length;\n    if (isArrayTrue || isObjectTrue || !['null', '', 'undefined'].includes(String(item))) {\n      newFilterValue[key] = item;\n    }\n  });\n  return newFilterValue;\n}\n\nexport default function useFilter(props: TdPrimaryTableProps, primaryTableRef: MutableRefObject<any>) {\n  const [locale, t] = useLocaleReceiver('table');\n  const { tableFilterClasses, isFocusClass } = useClassName();\n  const [isTableOverflowHidden, setIsTableOverflowHidden] = useState<boolean>();\n\n  // unControl and control\n  const [tFilterValue, setTFilterValue] = useControlled(props, 'filterValue', props.onFilterChange);\n\n  // 过滤内部值\n  const [innerFilterValue, setInnerFilterValue] = useState<FilterValue>(tFilterValue);\n\n  const hasEmptyCondition = (() => {\n    const filterEmpty = filterEmptyData(tFilterValue || {});\n    return !tFilterValue || !Object.keys(filterEmpty).length;\n  })();\n\n  useEffect(() => {\n    setInnerFilterValue(tFilterValue);\n  }, [tFilterValue]);\n\n  function renderFirstFilterRow() {\n    if (hasEmptyCondition) return null;\n    const defaultNode = (\n      <div className={tableFilterClasses.result}>\n        <span>\n          {/* 搜索 “{getFilterResultContent()}”， */}\n          {/* 找到 {props.pagination?.total || props.data?.length} 条结果 */}\n          {t(locale.searchResultText, {\n            result: getFilterResultContent(),\n            count: props.pagination?.total || props.data?.length,\n          })}\n        </span>\n        <TButton theme=\"primary\" variant=\"text\" onClick={onResetAll}>\n          {locale.clearFilterResultButtonText}\n        </TButton>\n      </div>\n    );\n    const filterContent = props.filterRow;\n    if (props.filterRow && !filterContent) return null;\n    const r = filterContent || defaultNode;\n    if (!r) return null;\n    return <div className={tableFilterClasses.inner}>{r}</div>;\n  }\n\n  // 获取搜索条件内容，存在 options 需要获取其 label 显示\n  function getFilterResultContent(): string {\n    const arr: string[] = [];\n    props.columns\n      .filter((col) => col.filter)\n      .forEach((col) => {\n        let value = tFilterValue[col.colKey];\n        if (col.filter.list && !['null', '', 'undefined'].includes(String(value))) {\n          const formattedValue = value instanceof Array ? value : [value];\n          const label: string[] = [];\n          col.filter.list.forEach((option) => {\n            if (formattedValue.includes(option.value)) {\n              label.push(option.label);\n            }\n          });\n          value = label.join();\n        }\n        if (value) {\n          arr.push(`${col.title}：${value}`);\n        }\n      });\n    return arr.join('；');\n  }\n\n  function onInnerFilterChange(val: any, column: PrimaryTableCol) {\n    const filterValue = {\n      ...innerFilterValue,\n      [column.colKey]: val,\n    };\n    setInnerFilterValue(filterValue);\n    if (!column.filter.showConfirmAndReset) {\n      emitFilterChange(filterValue, column);\n    }\n  }\n\n  function emitFilterChange(filterValue: FilterValue, column?: PrimaryTableCol) {\n    setTFilterValue(filterValue, { col: column });\n    props.onChange?.({ filter: filterValue }, { trigger: 'filter' });\n  }\n\n  function onReset(column: PrimaryTableCol) {\n    const filterValue: FilterValue = {\n      ...tFilterValue,\n      [column.colKey]:\n        {\n          single: '',\n          multiple: [],\n          input: '',\n        }[column.filter.type] ||\n        column.filter.resetValue ||\n        '',\n    };\n    emitFilterChange(filterValue, column);\n  }\n\n  function onResetAll() {\n    emitFilterChange({}, undefined);\n  }\n\n  function onConfirm(column: PrimaryTableCol) {\n    emitFilterChange(innerFilterValue, column);\n  }\n\n  // 图标：内置图标，组件自定义图标，全局配置图标\n  function renderFilterIcon({ col }: { col: PrimaryTableCol<TableRowData>; colIndex: number }) {\n    return (\n      <TableFilterController\n        column={col}\n        filterIcon={props.filterIcon}\n        tFilterValue={tFilterValue}\n        innerFilterValue={innerFilterValue}\n        tableFilterClasses={tableFilterClasses}\n        isFocusClass={isFocusClass}\n        onReset={onReset}\n        onConfirm={onConfirm}\n        onInnerFilterChange={onInnerFilterChange}\n        primaryTableElement={primaryTableRef?.current?.tableElement}\n        onVisibleChange={onPopupVisibleChange}\n      ></TableFilterController>\n    );\n  }\n\n  function onPopupVisibleChange(visible: boolean) {\n    if (visible && !isTableOverflowHidden) {\n      setIsTableOverflowHidden(!visible);\n    }\n  }\n\n  return {\n    hasEmptyCondition,\n    isTableOverflowHidden,\n    renderFilterIcon,\n    renderFirstFilterRow,\n  };\n}\n"],"names":["filterEmptyData","data","newFilterValue","Object","keys","forEach","key","item","isArrayTrue","Array","length","isObject","isObjectTrue","includes","String","useFilter","props","primaryTableRef","useLocaleReceiver","locale","t","useClassName","tableFilterClasses","isFocusClass","useState","isTableOverflowHidden","setIsTableOverflowHidden","useControlled","onFilterChange","tFilterValue","setTFilterValue","innerFilterValue","setInnerFilterValue","hasEmptyCondition","filterEmpty","useEffect","renderFirstFilterRow","defaultNode","React","createElement","className","result","searchResultText","getFilterResultContent","count","pagination","total","TButton","theme","variant","onClick","onResetAll","clearFilterResultButtonText","filterContent","filterRow","r","inner","arr","columns","filter","col","value","colKey","list","formattedValue","label","option","push","join","title","onInnerFilterChange","val","column","filterValue","showConfirmAndReset","emitFilterChange","onChange","trigger","onReset","single","multiple","input","type","resetValue","onConfirm","renderFilterIcon","TableFilterController","filterIcon","primaryTableElement","current","tableElement","onVisibleChange","onPopupVisibleChange","visible"],"mappings":"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"}