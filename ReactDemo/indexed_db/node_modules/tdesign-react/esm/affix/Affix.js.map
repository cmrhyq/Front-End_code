{"version":3,"file":"Affix.js","sources":["../../src/affix/Affix.tsx"],"sourcesContent":["import React, { useEffect, forwardRef, useCallback, useImperativeHandle, useRef } from 'react';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps, ScrollContainerElement } from '../common';\nimport { TdAffixProps } from './type';\nimport { getScrollContainer } from '../_util/dom';\nimport useConfig from '../hooks/useConfig';\nimport { affixDefaultProps } from './defaultProps';\n\nexport interface AffixProps extends TdAffixProps, StyledProps {\n  children: React.ReactNode;\n}\n\nexport interface AffixRef {\n  handleScroll: () => void;\n}\n\nconst Affix = forwardRef<AffixRef, AffixProps>((props, ref) => {\n  const { children, zIndex, container, offsetBottom, offsetTop, className, style, onFixedChange } = props;\n\n  const { classPrefix } = useConfig();\n\n  const affixRef = useRef<HTMLDivElement>(null);\n  const affixWrapRef = useRef<HTMLDivElement>(null);\n  const placeholderEL = useRef<HTMLElement>(null);\n  const scrollContainer = useRef<ScrollContainerElement>(null);\n\n  const ticking = useRef(false);\n\n  // 这里是通过控制 wrap 的 border-top 到浏览器顶部距离和 offsetTop 比较\n  const handleScroll = useCallback(() => {\n    if (!ticking.current) {\n      window.requestAnimationFrame(() => {\n        // top = 节点到页面顶部的距离，包含 scroll 中的高度\n        const {\n          top: wrapToTop = 0,\n          width: wrapWidth = 0,\n          height: wrapHeight = 0,\n        } = affixWrapRef.current?.getBoundingClientRect() ?? { top: 0 };\n\n        // 容器到页面顶部的距离, windows 为0\n        let containerToTop = 0;\n        if (scrollContainer.current instanceof HTMLElement) {\n          containerToTop = scrollContainer.current.getBoundingClientRect().top;\n        }\n\n        const calcTop = wrapToTop - containerToTop; // 节点顶部到 container 顶部的距离\n        const containerHeight =\n          scrollContainer.current[scrollContainer.current instanceof Window ? 'innerHeight' : 'clientHeight'] -\n          wrapHeight;\n        const calcBottom = containerToTop + containerHeight - (offsetBottom ?? 0); // 计算 bottom 相对应的 top 值\n\n        let fixedTop: number | false;\n        if (offsetTop !== undefined && calcTop <= offsetTop) {\n          // top 的触发\n          fixedTop = containerToTop + offsetTop;\n        } else if (offsetBottom !== undefined && wrapToTop >= calcBottom) {\n          // bottom 的触发\n          fixedTop = calcBottom;\n        } else {\n          fixedTop = false;\n        }\n\n        if (affixRef.current) {\n          const affixed = fixedTop !== false;\n          const placeholderStatus = affixWrapRef.current.contains(placeholderEL.current);\n\n          if (affixed) {\n            // 定位\n            affixRef.current.className = `${classPrefix}-affix`;\n            affixRef.current.style.top = `${fixedTop}px`;\n            affixRef.current.style.width = `${wrapWidth}px`;\n            affixRef.current.style.height = `${wrapHeight}px`;\n\n            if (zIndex) {\n              affixRef.current.style.zIndex = `${zIndex}`;\n            }\n\n            // 插入占位节点\n            if (!placeholderStatus) {\n              placeholderEL.current.style.width = `${wrapWidth}px`;\n              placeholderEL.current.style.height = `${wrapHeight}px`;\n              affixWrapRef.current.appendChild(placeholderEL.current);\n            }\n          } else {\n            affixRef.current.removeAttribute('class');\n            affixRef.current.removeAttribute('style');\n\n            // 删除占位节点\n            placeholderStatus && placeholderEL.current.remove();\n          }\n\n          if (isFunction(onFixedChange)) {\n            onFixedChange(affixed, { top: +fixedTop });\n          }\n        }\n\n        ticking.current = false;\n      });\n    }\n    ticking.current = true;\n  }, [classPrefix, offsetBottom, offsetTop, onFixedChange, zIndex]);\n\n  useImperativeHandle(ref, () => ({\n    handleScroll,\n  }));\n\n  useEffect(() => {\n    // 创建占位节点\n    placeholderEL.current = document.createElement('div');\n  }, []);\n\n  useEffect(() => {\n    scrollContainer.current = getScrollContainer(container);\n    if (scrollContainer.current) {\n      handleScroll();\n      scrollContainer.current.addEventListener('scroll', handleScroll);\n      window.addEventListener('resize', handleScroll);\n\n      return () => {\n        scrollContainer.current.removeEventListener('scroll', handleScroll);\n        window.removeEventListener('resize', handleScroll);\n      };\n    }\n  }, [container, handleScroll]);\n\n  return (\n    <div ref={affixWrapRef} className={className} style={style}>\n      <div ref={affixRef}>{children}</div>\n    </div>\n  );\n});\n\nAffix.displayName = 'Affix';\nAffix.defaultProps = affixDefaultProps;\n\nexport default Affix;\n"],"names":["Affix","forwardRef","props","ref","children","zIndex","container","offsetBottom","offsetTop","className","style","onFixedChange","useConfig","classPrefix","affixRef","useRef","affixWrapRef","placeholderEL","scrollContainer","ticking","handleScroll","useCallback","current","window","requestAnimationFrame","getBoundingClientRect","top","wrapToTop","width","wrapWidth","height","wrapHeight","containerToTop","HTMLElement","calcTop","containerHeight","Window","calcBottom","fixedTop","affixed","placeholderStatus","contains","appendChild","removeAttribute","remove","isFunction","useImperativeHandle","useEffect","document","createElement","getScrollContainer","addEventListener","removeEventListener","React","displayName","defaultProps","affixDefaultProps"],"mappings":"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"}